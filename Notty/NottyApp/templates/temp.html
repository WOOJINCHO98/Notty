
def real_min(request):
if request.method == 'POST':
    print('post')
else:
    global real_time_position
    global destword       
    global real_time_line
    global min_path_time
    global min_real_path_list
    global real_next_station
    global min_path_trans_cnt
    global min_path_msg
    global arrive_tag
    global left_tag
    global last_time
    global found
    global time_tag
    arrive_tag = 0
    time_tag = 0
    left_tag = 0
    print('get요청? in min')
    
    
    
    form = RouteForm()

    #1호선 K 로 시작하는 열차번호 처리
    for item in sht_joined_train_num_list:
        if item.startswith('K'):
            item.replace('K','0')
            
    
    #서울시 지하철 실시간 열차 위치정보 http://data.seoul.go.kr/dataList/OA-12601/A/1/datasetView.do

    # 선택 시간 받아오기 GET 요청
    selected_time = request.GET.get('time_table')
    print('선택된 시간',selected_time)
    if selected_time == 'first':
        time_tag = 0
        print('first selected')
    elif selected_time == 'second':
        time_tag = 1
    elif selected_time == 'third':
        time_tag = 2
    #elif selected_time == 'last':
    #    time_tag = -1
        

    real_time_url = 'http://swopenAPI.seoul.go.kr/api/subway/'+path_key+'/json/realtimePosition/0/100/'+temp_line
    real_time_response = requests.get(real_time_url)
    real_time_resdata = real_time_response.text
    real_time_obj = json.loads(real_time_resdata)
    try:
        real_time_obj = real_time_obj['realtimePositionList']
    except KeyError:
        print('KEY ERROR')
        return render(request,'real_min.html',{'left_tag':left_tag,'last_time':last_time,'arrive_tag':arrive_tag,'real_next_station':real_next_station,'real_time_line':real_time_line,'sht_joined_time_table_list':sht_joined_time_table_list,'real_time_position':real_time_position,'destword':destword})
    
    #print(real_time_obj)
    
    

    try:
        for item in real_time_obj:

            if sht_joined_train_num_list[0+time_tag]==item.get('trainNo'):
                print(item.get('trainNo'))
                real_time_line = item.get('subwayNm')
                real_time_position = item.get('statnNm')
                print(real_time_position)
                

    except AttributeError:
        print('AttributeError')    
    except IndexError:
        print('IndexError')
    
    
    if real_time_position == '공릉(서울산업대입구)':
        real_time_position = '공릉'
    
    print(real_time_position)
    print(destword)
    
    
    if real_time_position != destword:
    
    
        #현재 역 다음 역 찾기.
        #지하철 경로 조회 서비스 https://devming.tistory.com/214 |http://swopenAPI.seoul.go.kr/api/subway/인증Key값/요청데이터형식/OpenAPI 이름(서비스명)/요청 데이터 행 시작번호/요청 데이터 행 끝번호/출발역명/도착역명
        

        
        path_api_url = 'http://swopenAPI.seoul.go.kr/api/subway/'+key_num+'/json/shortestRoute/0/10/'+real_time_position+'/'+destword
        path_response = requests.get(path_api_url)
        path_resdata = path_response.text
        path_obj = json.loads(path_resdata)
        try:
            path_obj = path_obj['shortestRouteList']
        except KeyError:
            print("keyerror")
            return render(request,'real_min.html',{'left_tag':left_tag,'last_time':last_time,'arrive_tag':arrive_tag,'real_next_station':real_next_station,'real_time_line':real_time_line,'sht_joined_time_table_list':sht_joined_time_table_list,'real_time_position':real_time_position,'destword':destword})
            
        #최단 시간 찾기
        path_time = [9999,9999,9999,9999,9999,9999,9999,9999,9999,9999]
        
        i=0
        try:
            for time_set in path_obj:
                path_time[i] = int(time_set.get('shtTravelTm'))
                i=i+1
        except AttributeError:
            print("AttributeError")
        min_sht_path_time = min(path_time)
             
        try:
            for item in path_obj:
                min_real_path_list = item.get('shtStatnNm')
                #min_path_msg = item.get('shtTravelMsg') 실시간 기반 소요 시간 환승 횟수 메시지
                #min_path_trans_cnt = item.get('shtTransferCnt') 실시간 기반 환승 횟수
                #sht_path_time = item.get('shtTravelTm') 실시간 기반 소요 시간
                if min_sht_path_time == int(item.get('shtTravelTm')):
                    break
        except AttributeError:
            print('AttributeError')   
        print(min_real_path_list)     
        
        try:
            min_real_path_list = min_real_path_list.replace(" ","")
            min_real_path_list = min_real_path_list.split(',')        
        except AttributeError:
            print('Attribute Error')
        try: 
            found = min_real_path_list.index(min_path_time[0])
        except ValueError:
            print('valueError')
        #print(min_real_path_list[found])
        #print(min_real_path_list[found-2])
        if real_time_position == min_real_path_list[found]:
            left_tag = 1
        elif real_time_position == min_real_path_list[found-1]:
            left_tag = 2
        elif real_time_position == min_real_path_list[found-2]:
            left_tag = 3
        elif real_time_position == min_real_path_list[found-3]:
            left_tag = 4
        elif real_time_position == min_real_path_list[-2]:
            arrive_tag = 1
            print('도착역 도착')
        elif real_time_position == min_real_path_list[-3]:
            arrive_tag = 2
            print('도착역 전 역 도착')
        elif real_time_position == min_real_path_list[-4]:
            arrive_tag = 3
            print('도착역 전전역 도착')
        else: 
            print("도착 태그 예외")
        #실시간 다음역 지정
        real_next_station = min_real_path_list[1]
    else:
        print('도착')
        return render(request,'arrive.html')

return render(request,'real_min.html',{'left_tag':left_tag,'last_time':last_time,'arrive_tag':arrive_tag,'real_next_station':real_next_station,'real_time_line':real_time_line,'sht_joined_time_table_list':sht_joined_time_table_list,'real_time_position':real_time_position,'destword':destword})
